### Tenant-Scoped Feed – Implementation Roadmap

| #     | Area                                | Detailed Tasks Still **TODO**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Rationale / Implementation Notes                                                                                                                                                             |
| ----- | ----------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1** | **API / Data layer**                | 1. **Add `tenant_id` support to endpoints** ↳ Update `/api/feed/unified` (+ any derivative endpoints) to accept a `tenant_id` query parameter **and** fall back to the tenant ID detected from an HttpOnly cookie.<br/>2. **Query filtering** ↳ In the SQL or Supabase RPC, `WHERE collective_id = :tenant_id` (for collective feeds) **or** `WHERE tenant_id = :tenant_id` for generic views.<br/>3. **React-Query keys** ↳ Change hooks to use `['unified-feed', tenantId, limit]` so caches are isolated per tenant.<br/>4. **SSR hydration** ↳ Pass `initialTenantId` from `RootLayout` to the feed hook for first paint without client flicker. | Ensures data isolation & leverages per-tenant cache buckets to avoid cross-pollution between collectives. Cookie fallback keeps URL clean while allowing server actions to know the context. |
| **2** | **Center-Feed UI (scope selector)** | 1. **Dropdown component** ↳ Place at top-left of feed: `⟨ TenantName ⟩ ▼`.<br/>2. **Options** • _This collective_ (tenant-scoped) • _All collectives_ (global).<br/>3. **State handling** ↳ Persist last user choice to `sessionStorage` (`feed.scope`).<br/>4. **Behaviour** ↳ Changing scope invalidates React-Query cache & trims scroll position to top.<br/>5. **Accessibility** ↳ Use `role="menu"` + keyboard arrow / ESC support.                                                                                                                                                                                                            | Prevents accidental posting in wrong context and gives power-users a way to hop back to the global view. Remembering the choice keeps UX consistent across refreshes.                        |
| **3** | **Visual context cues**             | 1. **Banner / breadcrumb** ↳ Thin coloured bar (tenant colour) with text _“Viewing: Acme Writers”_.<br/>2. **Automatic update** ↳ Subscribe to `tenantStore.currentTenant` and animate colour shift.<br/>3. **Page title augmentation** ↳ `document.title = "/Home – " + tenant.name` for clarity in browser history.<br/>4. **Post composer guard** ↳ Show a small pill _“Posting to Acme Writers”_ inside composer header.                                                                                                                                                                                                                         | Reinforces mental model & reduces mis-scopes, especially when users multitask across many tabs.                                                                                              |
| **4** | **Chain feed (activity stream)**    | 1. **Primary query** ↳ Show events where `tenant_id = currentTenantId` sorted by recency.<br/>2. **Secondary section** ↳ Collapsible panel labeled _“Network activity”_ with global events.<br/>3. **Hook adjustments** ↳ Extend `useFeedRealtime` to accept a `tenantOnly` flag; only broadcast tenant-specific updates when flag is `true`.<br/>4. **Visual grouping** ↳ Use headings or cards to separate _Local_ vs _Global_ streams.                                                                                                                                                                                                            | Keeps collective governance signals front-and-center while still enabling discovery across the wider network.                                                                                |
| **5** | **Edge-case guardrails**            | 1. **Deep-link switcher** ↳ When loading `/posts/{id}` fetch its `tenant_id`; if different from `currentTenantId`, call `tenantStore.actions.switchTenant(id)` and show toast "Switched to … to view this post".<br/>2. **Membership loss handler** ↳ On any 403/404 from feed queries, check if it’s due to lost membership; if so, revert to global feed and warn the user.<br/>3. **URL param override** ↳ Accept `?tenant=all` to force global view regardless of store state (useful for sharable links).                                                                                                                                       | Prevents blank feeds or RLS errors and provides clear messaging when context changes outside the user’s control.                                                                             |
| **6** | **Analytics / Telemetry**           | 1. Track `feed_scope_changed` with `{ from, to, tenantId }`.<br/>2. Track `tenant_auto_switch` events with `{ postId, tenantId }`.<br/>3. Dashboard metrics: number of scoped vs global views, bounce rate, mis-post corrections.<br/>4. A/B test banner designs & placement.                                                                                                                                                                                                                                                                                                                                                                        | Data-driven validation of UX assumptions; helps decide if default scoping needs adjustment.                                                                                                  |

> **Implementation order:** Finish **1 – 3** first to ship the core tenant-scoped experience. Follow up with **4 – 6** for polish, resilience, and insight.
