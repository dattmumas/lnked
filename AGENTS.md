Implement Enhanced Auth Middleware
Objective: Strengthen route clarity and authentication gating for private pages.
Summary: Refine the Next.js middleware.ts to ensure all private routes are protected and public pages remain accessible. Currently, only the /dashboard/* paths are gated, and other authenticated routes rely on in-page checks
github.com
github.com
. We will expand the middleware’s matcher to include any routes that require login (e.g. /settings, /posts/new, /posts/*/edit) so that unauthorized users are consistently redirected to sign-in. This centralizes access control and removes duplicate checks in individual pages. The middleware logic will also be kept simple and clear: if no session on a private route, redirect to /sign-in; if logged in and hitting auth pages, redirect to dashboard (as already done)
github.com
.
Key Files/Components: middleware.ts (update matcher patterns and conditions)
github.com
github.com
, any pages with manual auth checks (e.g. src/app/settings/page.tsx, src/app/(editor)/posts/new/page.tsx) to remove redundant gating logic.
Codex Best Practices: Use atomic commits focusing only on auth middleware changes. Write a descriptive PR title like “feat: unify route authentication gating”. Ensure thorough testing of route access (e.g. try accessing protected URLs without login) to verify redirects. Maintain modularity by keeping middleware focused on routing logic, and avoid side effects beyond setting auth cookies. Document these changes for team awareness since URL access patterns will shift (update README or internal docs).
Restructure Route Paths for Clarity
Objective: Enforce a clearer separation of public vs. private content routes and prepare for new layout structures (e.g. breadcrumbs).
Summary: Reorganize the routing scheme so that URLs make the site sections obvious. First, move collective pages under a dedicated prefix – e.g. change the dynamic collective route from /[collectiveSlug] to /collectives/[slug]. This ensures no conflict with user profiles and clearly identifies collective content in URLs (currently, collective pages are at the root path with just the slug
github.com
). Similarly, keep all personal/private pages under a common section. We will introduce a Next.js route group for dashboard or user-specific pages if not already (e.g. ensure profile editing and settings live under /dashboard or similar). For example, the profile edit page could be /dashboard/profile/edit (already exists), and account settings could reside at /dashboard/settings instead of a top-level /settings. Consolidating these under one hierarchy improves navigational clarity. After moving routes, implement Next.js rewrites or redirects for any changed paths (e.g. redirect old collective URLs to new ones) to avoid broken links. This route refactor will also allow using Next 13 layouts more effectively: we can have a src/app/collectives/layout.tsx to wrap all collective pages, and a src/app/dashboard/layout.tsx to wrap all private pages, each providing appropriate context like sidebars or breadcrumbs. We will update the middleware config to match the new structure (e.g. include /collectives/:path* if certain subroutes should be gated or just keep them public). These changes set the stage for consistent breadcrumbs since the URL hierarchy will mirror content hierarchy (e.g. Home / Collectives / [Name] / [Post]).
Key Files/Components: Next.js route definitions in src/app: move src/app/[collectiveSlug]/* to src/app/collectives/[slug]/*; possibly adjust src/app/users/[userId] if we introduce a new profile route (see step 3). Introduce or modify layout files like src/app/collectives/layout.tsx and ensure src/app/dashboard/layout.tsx (or equivalent) exists to style private sections. Update navigation components (links in Navbar.tsx, etc.) to use new paths. Adjust middleware.ts matcher to include or accommodate the new route patterns.
Codex Best Practices: Break this into atomic commits: one for moving/renaming collective routes, another for updating nav links and middleware. Use clear commit messages (e.g. “refactor: move collective pages under /collectives”). Verify that all internal links (nav, buttons) point to the new URLs. After restructuring, run the test suite and click through the app to catch any 404s or broken navigation. Leverage code review to ensure no stale references to old routes remain. This reorganization should improve maintainability, so keep the routing code and file structure intuitive (one purpose per route file). Add redirect logic for legacy URLs to preserve SEO – this can be done in Next.js config or middleware, aligning with best practice of not breaking existing links.
s
